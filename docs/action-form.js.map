{"version":3,"file":"action-form.js","sources":["../src/action-form.ts"],"sourcesContent":["import type ActionFormStep from \"./af-step\";\nimport type ActionFormError from \"./af-error\";\nimport type ActionFormGroupCount from \"./af-group-count\";\n\nexport default class ActionForm extends HTMLElement {\n\tpublic stepIndex: number = 0; // current step\n\n\tprivate watchers: { el: HTMLElement; name: string; value?: string; regex?: RegExp }[] = [];\n\n\tconstructor() {\n\t\tsuper();\n\t\tdocument.documentElement.classList.add(\"js\");\n\n\t\tconst form = this.querySelector(\"form\");\n\t\tif (form) {\n\t\t\t/*\n\t\t\t * Set novalidate on the form if novalidate set on action-form.\n\t\t\t * This way novalidate is only set if javascript is loaded and form-action is defined.\n\t\t\t * We want to allow falling back to browser validation if javascript is not loaded.\n\t\t\t */\n\t\t\tif (this.hasAttribute(\"novalidate\")) {\n\t\t\t\tform.setAttribute(\"novalidate\", \"\");\n\t\t\t}\n\n\t\t\tthis.steps.forEach((step, i) => {\n\t\t\t\tstep.setAttribute(\"index\", String(i)); // step.index = i;\n\t\t\t\tif (i === 0) {\n\t\t\t\t\tstep.classList.add(\"first\", \"active\");\n\t\t\t\t}\n\t\t\t\tif (i === this.steps.length - 1) {\n\t\t\t\t\tstep.classList.add(\"last\");\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// console.log(\"validationFields\", validationFields.length);\n\n\t\t\tthis.addEventListener(\"af-step\", (event) => {\n\t\t\t\tconst customEvent = event as CustomEvent<{ step?: number; direction?: \"next\" | \"prev\" }>;\n\t\t\t\tconsole.log(\"af-step\", customEvent.detail?.step);\n\t\t\t\tlet stepIndex = this.stepIndex;\n\t\t\t\tif (typeof customEvent.detail?.step === \"number\") {\n\t\t\t\t\tstepIndex = customEvent.detail.step;\n\t\t\t\t} else if (customEvent.detail?.direction === \"next\") {\n\t\t\t\t\tstepIndex++;\n\t\t\t\t} else if (customEvent.detail?.direction === \"prev\") {\n\t\t\t\t\tstepIndex--;\n\t\t\t\t}\n\t\t\t\t// make sure stepIndex is within bounds\n\t\t\t\tstepIndex = Math.max(0, Math.min(stepIndex, this.steps.length - 1));\n\t\t\t\t// set this.stepIndex\n\t\t\t\tthis.stepIndex = stepIndex;\n\t\t\t\t// set active based on index\n\t\t\t\tArray.from(this.steps)\n\t\t\t\t\t.filter((step) => !step.hidden)\n\t\t\t\t\t.forEach((step, i) => {\n\t\t\t\t\t\t// set active based on index\n\t\t\t\t\t\tif (i === this.stepIndex) {\n\t\t\t\t\t\t\tstep.classList.add(\"active\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstep.classList.remove(\"active\");\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t});\n\n\t\t\t// Find all fields that require validation error messages\n\t\t\tif (this.hasAttribute(\"auto-error\")) {\n\t\t\t\tconst validationFields = this.querySelectorAll(\"[required],[pattern],[type=phone],[type=email],[type=url]\") as NodeListOf<\n\t\t\t\t\tHTMLInputElement | HTMLSelectElement | HTMLTextAreaElement\n\t\t\t\t>;\n\t\t\t\tvalidationFields.forEach((field) => {\n\t\t\t\t\tlet id = field.getAttribute(\"id\") || \"\";\n\t\t\t\t\t// Check if there is an af-error attribute for the field, either by id or withing parent label\n\t\t\t\t\tconst errorById = form.querySelector(`af-error[for=\"${id}\"]`);\n\t\t\t\t\tconst errorByProximity = field.closest(\"label\")?.querySelector(`af-error`);\n\t\t\t\t\tif (!errorById && !errorByProximity) {\n\t\t\t\t\t\t// if not then make one\n\t\t\t\t\t\tconst error = document.createElement(\"af-error\");\n\t\t\t\t\t\t// Use data-error for content\n\t\t\t\t\t\terror.textContent = field.dataset.error || \"\";\n\t\t\t\t\t\t// If there is no id attribute on field then make one just to make things easier\n\t\t\t\t\t\tif (!id) {\n\t\t\t\t\t\t\tid = `${field.id || field.name || field.tagName.toLowerCase()}-${Math.random().toString(36).substring(2, 9)}`;\n\t\t\t\t\t\t\tfield.setAttribute(\"id\", id);\n\t\t\t\t\t\t}\n\t\t\t\t\t\terror.setAttribute(\"for\", id);\n\t\t\t\t\t\t// add af-error after field\n\t\t\t\t\t\tfield.after(error);\n\t\t\t\t\t\tconsole.log(`Added Error Message for ${field.tagName.toLowerCase()}[${field.name}] #${id}`);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.enhanceElements();\n\n\t\t\tthis.addEventListener(\"change\", (event) => {\n\t\t\t\tconst target = event.target;\n\t\t\t\tif (target instanceof HTMLElement && target.matches(\"input, textarea, select, af-group-count\")) {\n\t\t\t\t\tconst field = target as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement | ActionFormGroupCount;\n\n\t\t\t\t\t// if target has an error message, show/hide it\n\t\t\t\t\tconst errorId = field.getAttribute(\"aria-describedby\");\n\t\t\t\t\tif (errorId) {\n\t\t\t\t\t\tconst errorMsg = document.getElementById(errorId);\n\t\t\t\t\t\tif (errorMsg?.matches(\"af-error\")) {\n\t\t\t\t\t\t\tconst afError = errorMsg as ActionFormError;\n\t\t\t\t\t\t\tconst valid = field.checkValidity();\n\t\t\t\t\t\t\tafError.showError(!valid);\n\t\t\t\t\t\t\t// console.log(\"target\", target, errorId, valid);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.checkWatchers();\n\t\t\t});\n\t\t}\n\t}\n\n\tpublic checkWatchers() {\n\t\t// Get FormData for watchers\n\t\tconst form = this.querySelector(\"form\");\n\t\tif (!form || this.watchers.length === 0) return;\n\t\tconst formData = new FormData(form);\n\t\t// Loop through watchers\n\t\tthis.watchers.forEach((watcher) => {\n\t\t\tconst values = formData.getAll(watcher.name);\n\t\t\t// console.log(\"watchers values\", values, watcher);\n\n\t\t\t// typeof value === \"string\" is to ignore formData files\n\t\t\tconst valid = values.some((value) => typeof value === \"string\" && (value === watcher.value || (watcher.regex && watcher.regex.test(value))));\n\t\t\t// if it is hidden and it is invalid, or vice versa, that means the state is fine so return.\n\t\t\tif (watcher.el.hasAttribute(\"hidden\") !== valid) return;\n\t\t\t// console.log(\"watcher\", watcher.name, valid);\n\t\t\t// Else show/hide it\n\t\t\tthis.show(watcher.el, valid);\n\t\t\t// if this is af-step then trigger event to update progress bar since there is a change in the number of steps\n\t\t\tif (watcher.el.matches(\"af-step\")) this.dispatchEvent(new CustomEvent(\"af-step\"));\n\t\t});\n\t}\n\n\tget steps(): NodeListOf<ActionFormStep> {\n\t\treturn this.querySelectorAll(\"af-step\") as NodeListOf<ActionFormStep>;\n\t}\n\n\tprivate enhanceElements() {\n\t\tconst elements = this.querySelectorAll(\"[data-watch]\") as NodeListOf<HTMLElement>;\n\t\telements.forEach((el) => {\n\t\t\tconst watch = el.dataset.watch;\n\t\t\tconst value = el.dataset.value;\n\t\t\tconst regexStr = el.dataset.regex;\n\t\t\t// if neither watch nor value is set, assume that any value is valid. RegExp /./ tests for any value\n\t\t\tconst regex: RegExp | undefined = regexStr ? new RegExp(regexStr) : !regexStr && !value ? /./ : undefined;\n\t\t\tif (watch) {\n\t\t\t\tthis.watchers.push({ name: watch, value, regex, el: el });\n\t\t\t}\n\t\t});\n\n\t\t// set Watchers from the start\n\t\tthis.checkWatchers();\n\t}\n\n\tprivate show(el: HTMLElement, show: boolean): void {\n\t\tif (show) {\n\t\t\tel.removeAttribute(\"hidden\");\n\t\t\tel.removeAttribute(\"disabled\");\n\t\t} else {\n\t\t\tel.setAttribute(\"hidden\", \"\");\n\t\t\tel.setAttribute(\"disabled\", \"\");\n\t\t}\n\t\t// TODO: is this needed?\n\t\tel.dispatchEvent(new CustomEvent(\"af-watcher\", { bubbles: true, detail: { show: show } }));\n\t}\n\n\t// public connectedCallback(): void {\n\t// \tconsole.log(\"connected\");\n\t// }\n\n\t// public attributeChangedCallback(name: string, oldValue: string, newValue: string) {\n\t// \tconsole.log(\"changed\", name, oldValue, newValue);\n\t// }\n}\ncustomElements.define(\"action-form\", ActionForm);\n"],"names":["ActionForm","__publicField","form","step","i","event","_a","_b","_c","_d","customEvent","stepIndex","field","id","errorById","errorByProximity","error","target","errorId","errorMsg","afError","valid","formData","watcher","value","el","watch","regexStr","regex","show"],"mappings":"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"}