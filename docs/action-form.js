var p=Object.defineProperty;var g=(d,f,r)=>f in d?p(d,f,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[f]=r;var u=(d,f,r)=>(g(d,typeof f!="symbol"?f+"":f,r),r);function m(d){return d instanceof HTMLInputElement||d instanceof HTMLTextAreaElement||d instanceof HTMLSelectElement}function y(){return Math.random().toString(36).substring(2)}function v(d){try{const f=JSON.parse(d);return!!f&&typeof f=="object"}catch{return!1}}class E extends HTMLElement{constructor(){super();u(this,"form",this.querySelector("form")||null);u(this,"steps",this.querySelectorAll("af-step"));u(this,"stepIndex",0);u(this,"storeKey",this.hasAttribute("store")?`action-form-${this.getAttribute("store")||this.id||this.form.id||y()}`:"");u(this,"watchers",[]);u(this,"persistedFields",[]);document.documentElement.classList.add("js");const r=this.form;r&&(this.hasAttribute("novalidate")&&r.setAttribute("novalidate",""),this.steps.forEach((a,t)=>{a.dataset.index=String(t),t===0&&a.classList.add("first","active"),t===this.steps.length-1&&a.classList.add("last")}),this.addEventListener("af-step",a=>{var o,i,n,l;const t=a;let e=this.stepIndex;typeof((o=t.detail)==null?void 0:o.step)=="number"?e=t.detail.step:(i=t.detail)!=null&&i.direction&&(console.log("step",(n=t.detail)==null?void 0:n.direction),e=e+((l=t.detail)==null?void 0:l.direction)),e=Math.max(0,Math.min(e,this.steps.length-1)),this.stepIndex=e;let s=0;Array.from(this.steps).forEach(h=>{h.style.display!=="none"?(h.dataset.index=String(s),s++):h.dataset.index="",s-1===e?(h.classList.add("active"),this.stepIndex=e):h.classList.remove("active")})}),this.hasAttribute("auto-error")&&(this.querySelectorAll("[required],[pattern],[type=phone],[type=email],[type=url]").forEach(e=>{var n;let s=e.id||"";const o=r.querySelector(`af-error[for="${s}"]`),i=(n=e.closest("label"))==null?void 0:n.querySelector("af-error");if(!o&&!i){const l=document.createElement("af-error");l.textContent=e.dataset.error||"",s||(s=`${e.name||e.tagName.toLowerCase()}-${Math.random().toString(36).substring(2,9)}`,e.setAttribute("id",s)),l.setAttribute("for",s),e.after(l),console.log(`Added Error Message for ${e.tagName.toLowerCase()}[${e.name}] #${s}`)}}),this.querySelectorAll("fieldset[data-group]").forEach(e=>{let s=e.id||"";if(!e.querySelector(`af-error[for="${s}"]`)){s||(s=`${e.name||"fieldset"}-${Math.random().toString(36).substring(2,9)}`,e.setAttribute("id",s));const n=document.createElement("af-error");n.setAttribute("for",s),n.textContent=e.dataset.error||"",e.append(n)}if(!e.querySelector("af-group-count")){const n=document.createElement("af-group-count");n.style.display="none",e.append(n)}})),this.enhanceElements(),this.addEventListener("change",a=>{const t=a.target;if(t instanceof HTMLElement&&t.matches("input, textarea, select, af-group-count")){const e=t,s=e.getAttribute("aria-describedby");if(s){const i=document.getElementById(s);if(i!=null&&i.matches("af-error")){const n=i,l=e.checkValidity();n.showError(!l)}}const o=this.watchers.filter(i=>i.name===e.name);if(o.length>0&&this.checkWatchers(o),this.storeKey){const i=localStorage.getItem(this.storeKey)||"{}";if(i&&e.name){const n=JSON.parse(i);if(e instanceof HTMLInputElement&&["checkbox","radio"].includes(e.type)){const l=n[e.name]instanceof Array?n[e.name]:[];e.checked?l.push(e.value):l.splice(l.indexOf(e.value),1),n[e.name]=l}else n[e.name]=e.value;localStorage.setItem(this.storeKey,JSON.stringify(n))}}}}),this.querySelectorAll("button[type=reset]").forEach(a=>{a.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.form.reset(),this.restoreForm()})}),this.addEventListener("submit",a=>{var e;if(r.checkValidity())this.resetStore();else{a.preventDefault(),console.error("Form validation failed");const s=r.querySelector("input:invalid, select:invalid, textarea:invalid, af-group-count[validity=false]");if(s){const o=s.closest("af-step");if(o&&this.dispatchEvent(new CustomEvent("af-step",{detail:{step:Number(o.dataset.index)}})),console.log("invalidField",s),s.matches("af-group-count")){const i=(e=s.closest("fieldset"))==null?void 0:e.querySelector("input, select, textarea");i==null||i.focus()}else s.focus();s.dispatchEvent(new Event("change",{bubbles:!0}))}}}))}restoreForm(){this.resetStore(),this.restoreFieldValues(),this.querySelectorAll("af-error[invalid]").forEach(c=>{c.showError(!1)}),this.checkWatchers(),this.dispatchEvent(new CustomEvent("af-step",{detail:{step:0}}))}resetStore(){const r=localStorage.getItem(this.storeKey);if(r&&this.persistedFields.length>0){const c=JSON.parse(r);Object.keys(c).forEach(a=>{this.persistedFields.includes(a)||delete c[a]}),localStorage.setItem(this.storeKey,JSON.stringify(c))}else localStorage.removeItem(this.storeKey)}enhanceElements(){this.querySelectorAll("[data-get-store]").forEach(t=>{const e=t.dataset.getStore;if(e&&m(t)){const s=e.split("."),o=localStorage.getItem(s[0]);if(o)if(v(o)&&s.length>1){const i=JSON.parse(o)[s[1]];i&&(t.value=String(i))}else t.value=o}}),this.restoreFieldValues(),this.querySelectorAll("[data-if],[data-text]").forEach(t=>{const e=t.dataset.if||t.dataset.text,s=t.dataset.ifValue,o=t.dataset.ifNotValue,i=t.dataset.ifRegex,n=i?new RegExp(i):void 0;e&&this.watchers.push({name:e,if:!!t.dataset.if,text:!!t.dataset.text,value:s,notValue:o,regex:n,el:t})}),this.checkWatchers();const a=this.querySelectorAll("[data-persist]");this.persistedFields=Array.from(a).map(t=>m(t)?t.name:"")}restoreFieldValues(){const r=localStorage.getItem(this.storeKey);if(!r)return;const c=JSON.parse(r);typeof c=="object"&&Object.keys(c).forEach(a=>{this.querySelectorAll(`[name="${a}"]`).forEach(e=>{m(e)&&!e.matches("[type=hidden]")&&(e instanceof HTMLInputElement&&["checkbox","radio"].includes(e.type)&&c[a]instanceof Array?e.checked=c[a].includes(e.value):e.value=String(c[a]))})})}checkWatchers(r=this.watchers){console.log("checkWatchers",r);const c=this.querySelector("form");if(!c||r.length===0)return;const a=new FormData(c);r.forEach(t=>{const e=a.getAll(t.name);if(t.text&&(t.el.textContent=e.join(", ")),t.if){let s=e.some(o=>typeof o=="string"&&(t.value||t.regex)?o===t.value||t.regex&&t.regex.test(o):!!o);t.notValue&&e.length!==0&&s&&(s=e.every(o=>o!==t.notValue)),this.show(t.el,s),t.el.matches("af-step")&&this.dispatchEvent(new CustomEvent("af-step"))}})}show(r,c){c?(r.style.display="",r.removeAttribute("disabled")):(r.style.display="none",r.setAttribute("disabled","")),r.dispatchEvent(new Event("change",{bubbles:!0}))}}customElements.define("action-form",E);
//# sourceMappingURL=action-form.js.map
