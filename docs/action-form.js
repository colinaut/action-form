var p=Object.defineProperty;var g=(d,h,r)=>h in d?p(d,h,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[h]=r;var f=(d,h,r)=>(g(d,typeof h!="symbol"?h+"":h,r),r);function m(d){return d instanceof HTMLInputElement||d instanceof HTMLTextAreaElement||d instanceof HTMLSelectElement}function y(){return Math.random().toString(36).substring(2)}function S(d){try{const h=JSON.parse(d);return!!h&&typeof h=="object"}catch{return!1}}class v extends HTMLElement{constructor(){super();f(this,"form",this.querySelector("form")||null);f(this,"steps",this.querySelectorAll("af-step"));f(this,"stepIndex",0);f(this,"storeKey",this.hasAttribute("store")?`action-form-${this.getAttribute("store")||this.id||this.form.id||y()}`:"");f(this,"persistedFields",[]);f(this,"watchers",[]);f(this,"storeGetFields");f(this,"storeListenFields");document.documentElement.classList.add("js");const r=this.form;r&&(this.hasAttribute("novalidate")&&r.setAttribute("novalidate",""),this.steps.forEach((t,s)=>{t.dataset.index=String(s),s===0&&t.classList.add("first","active"),s===this.steps.length-1&&t.classList.add("last")}),this.addEventListener("af-step",t=>{var l,i,n,c;const s=t;let e=this.stepIndex;typeof((l=s.detail)==null?void 0:l.step)=="number"?e=s.detail.step:(i=s.detail)!=null&&i.direction&&(console.log("step",(n=s.detail)==null?void 0:n.direction),e=e+((c=s.detail)==null?void 0:c.direction)),e=Math.max(0,Math.min(e,this.steps.length-1)),this.stepIndex=e;let o=0;Array.from(this.steps).forEach(u=>{u.style.display!=="none"?(u.dataset.index=String(o),o++):u.dataset.index="",o-1===e?(u.classList.add("active"),this.stepIndex=e):u.classList.remove("active")})}),this.hasAttribute("auto-error")&&(this.querySelectorAll("[required],[pattern],[type=phone],[type=email],[type=url]").forEach(e=>{var n;let o=e.id||"";const l=r.querySelector(`af-error[for="${o}"]`),i=(n=e.closest("label"))==null?void 0:n.querySelector("af-error");if(!l&&!i){const c=document.createElement("af-error");c.textContent=e.dataset.error||"",o||(o=`${e.name||e.tagName.toLowerCase()}-${Math.random().toString(36).substring(2,9)}`,e.setAttribute("id",o)),c.setAttribute("for",o),e.after(c),console.log(`Added Error Message for ${e.tagName.toLowerCase()}[${e.name}] #${o}`)}}),this.querySelectorAll("fieldset[data-group]").forEach(e=>{let o=e.id||"";if(!e.querySelector(`af-error[for="${o}"]`)){o||(o=`${e.name||"fieldset"}-${Math.random().toString(36).substring(2,9)}`,e.setAttribute("id",o));const n=document.createElement("af-error");n.setAttribute("for",o),n.textContent=e.dataset.error||"",e.append(n)}if(!e.querySelector("af-group-count")){const n=document.createElement("af-group-count");n.style.display="none",e.append(n)}})),this.enhanceElements(),this.addEventListener("change",t=>{const s=t.target;if(s instanceof HTMLElement&&s.matches("input, textarea, select, af-group-count")){const e=s,o=e.getAttribute("aria-describedby");if(o){const i=document.getElementById(o);if(i!=null&&i.matches("af-error")){const n=i,c=e.checkValidity();n.showError(!c)}}const l=this.watchers.filter(i=>i.name===e.name);if(l.length>0&&this.checkWatchers(l),this.storeKey){const i=localStorage.getItem(this.storeKey)||"{}";if(i&&e.name){const n=JSON.parse(i);if(e instanceof HTMLInputElement&&["checkbox","radio"].includes(e.type)){const c=n[e.name]instanceof Array?n[e.name]:[];e.checked?c.push(e.value):c.splice(c.indexOf(e.value),1),n[e.name]=c}else n[e.name]=e.value;localStorage.setItem(this.storeKey,JSON.stringify(n))}}if(m(e)&&e.dataset.storeSet){const i=e.dataset.storeSet.split(".");let n=e.value;if(i.length>1){const c=JSON.parse(localStorage.getItem(i[0])||"{}");n=JSON.stringify({...c,[i[1]]:e.value})}localStorage.setItem(i[0],n)}}}),this.querySelectorAll("button[type=reset]").forEach(t=>{t.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.form.reset(),this.restoreForm()})}),this.addEventListener("submit",t=>{var e;if(r.checkValidity())this.resetStore();else{t.preventDefault(),console.error("Form validation failed");const o=r.querySelector("input:invalid, select:invalid, textarea:invalid, af-group-count[validity=false]");if(o){const l=o.closest("af-step");if(l&&this.dispatchEvent(new CustomEvent("af-step",{detail:{step:Number(l.dataset.index)}})),console.log("invalidField",o),o.matches("af-group-count")){const i=(e=o.closest("fieldset"))==null?void 0:e.querySelector("input, select, textarea");i==null||i.focus()}else o.focus();o.dispatchEvent(new Event("change",{bubbles:!0}))}}}),window.addEventListener("storage",t=>{console.log("storage",t,t.key),this.storeListenFields&&Array.from(this.storeListenFields).filter(e=>{var o;return m(e)&&((o=e.dataset.storeGet)==null?void 0:o.split(".")[0])===t.key}).forEach(e=>this.updateStoreField(e)),this.hasAttribute("store-listen")&&t.key===this.storeKey&&this.restoreFieldValues()}))}restoreForm(){this.resetStore(),this.updateStoreFields(this.storeGetFields),this.restoreFieldValues(),this.querySelectorAll("af-error[invalid]").forEach(a=>{a.showError(!1)}),this.checkWatchers(),this.dispatchEvent(new CustomEvent("af-step",{detail:{step:0}}))}resetStore(){const r=localStorage.getItem(this.storeKey);if(r&&this.persistedFields.length>0){const a=JSON.parse(r);Object.keys(a).forEach(t=>{this.persistedFields.includes(t)||delete a[t]}),localStorage.setItem(this.storeKey,JSON.stringify(a))}else localStorage.removeItem(this.storeKey)}updateStoreFields(r){r.forEach(a=>{this.updateStoreField(a)})}updateStoreField(r){if(m(r)){const a=r.dataset.storeGet;if(!a)return;const t=a.split("."),s=localStorage.getItem(t[0]);if(s)if(S(s)&&t.length>1){const e=JSON.parse(s)[t[1]];e&&(r.value=String(e))}else r.value=s}}enhanceElements(){this.storeGetFields=this.querySelectorAll("[data-store-get]"),this.storeListenFields=this.querySelectorAll("[data-store-get][data-store-listen]"),this.storeGetFields.length>0&&this.updateStoreFields(this.storeGetFields),this.storeKey&&this.restoreFieldValues(),this.querySelectorAll("[data-if],[data-text]").forEach(t=>{const s=t.dataset.if||t.dataset.text,e=t.dataset.ifValue,o=t.dataset.ifNotValue,l=t.dataset.ifRegex,i=l?new RegExp(l):void 0;s&&this.watchers.push({name:s,if:!!t.dataset.if,text:!!t.dataset.text,value:e,notValue:o,regex:i,el:t})}),this.checkWatchers();const a=this.querySelectorAll("[data-persist]");this.persistedFields=Array.from(a).map(t=>m(t)?t.name:"")}restoreFieldValues(){const r=localStorage.getItem(this.storeKey);if(!r)return;const a=JSON.parse(r);typeof a=="object"&&Object.keys(a).forEach(t=>{this.querySelectorAll(`[name="${t}"]`).forEach(e=>{m(e)&&!e.matches("[type=hidden]")&&(e instanceof HTMLInputElement&&["checkbox","radio"].includes(e.type)&&a[t]instanceof Array?e.checked=a[t].includes(e.value):e.value=String(a[t]))})})}checkWatchers(r=this.watchers){console.log("checkWatchers",r);const a=this.querySelector("form");if(!a||r.length===0)return;const t=new FormData(a);r.forEach(s=>{const e=t.getAll(s.name);if(s.text&&(s.el.textContent=e.join(", ")),s.if){let o=e.some(l=>typeof l=="string"&&(s.value||s.regex)?l===s.value||s.regex&&s.regex.test(l):!!l);s.notValue&&e.length!==0&&o&&(o=e.every(l=>l!==s.notValue)),this.show(s.el,o),s.el.matches("af-step")&&this.dispatchEvent(new CustomEvent("af-step"))}})}show(r,a){a?(r.style.display="",r.removeAttribute("disabled")):(r.style.display="none",r.setAttribute("disabled","")),r.dispatchEvent(new Event("change",{bubbles:!0}))}}customElements.define("action-form",v);
//# sourceMappingURL=action-form.js.map
