var q=Object.defineProperty;var F=(o,c,t)=>c in o?q(o,c,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[c]=t;var m=(o,c,t)=>(F(o,typeof c!="symbol"?c+"":c,t),t);import{A as I}from"./af-field-group.js";import{a as E,c as v}from"./assets/signals-DHVSGanU.js";function S(o=""){return`${o?o+"-":""}${Math.random().toString(36).substring(2,9)}`}function b(o){return!!o&&(o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement||o instanceof HTMLSelectElement)}function x(o){return!!o&&(b(o)||o instanceof I)}class L extends HTMLElement{constructor(){super();m(this,"target",null);m(this,"shadow",this.attachShadow({mode:"open"}))}addAria(t){if(x(t)){const r=t.getAttribute("aria-describedby")||this.getAttribute("id")||S(t.id);this.setAttribute("id",r),t.setAttribute("aria-describedby",r)}}connectedCallback(){var s;this.style.visibility="hidden";const t=this.getAttribute("for")||"",r=t?document.getElementById(t):(s=this.closest("label"))==null?void 0:s.querySelector("input, select, textarea");x(r)&&(this.addAria(r),this.render())}static get observedAttributes(){return["data-invalid"]}attributeChangedCallback(t,r,s){t==="data-invalid"&&(s==="pattern"||s==="required")&&this.render(s)}render(t="required"){const r={required:"<slot>Required</slot>",pattern:'<slot name="pattern">Not filled in properly</slot>'};this.shadow.innerHTML=r[t]}}function M(o){const c=new Map,[t,r]=E(e());function s(){r(e())}function u(a){const i=f(a);if(c.has(a))c.get(a).set(i);else{const[n,h]=E(i);c.set(a,{get:n,set:h})}}function l(a){var i;return(i=c.get(a))==null?void 0:i.get()}function f(a){return new FormData(o).getAll(a)}function e(){const a=new FormData(o).keys(),i={};return Array.from(a).forEach(n=>{i[n]=f(n)}),i}return{set:u,get:l,getForm:t,setForm:s,formDataObject:e}}function w(o){const[c,t]=E(0),[r,s]=E(f()[0]),[u,l]=E(f().length);function f(){return Array.from(o).filter(d=>d.style.display!=="none")}function e(){l(f().length)}function a(d=0){t(d),s(f()[d])}function i(d=0){const y=c(),g=Math.max(0,Math.min(y+d,f().length-1));g!==y&&a(g)}function n(){i(-1)}function h(){const d=r().querySelector(":invalid:not(fieldset)");d instanceof HTMLElement?(d.focus(),d.dispatchEvent(new Event("change",{bubbles:!0,composed:!0}))):i(1)}return{all:o,getVisible:f,currentStep:r,stepIndex:c,stepsLength:u,updateSteps:e,set:a,move:i,prev:n,next:h}}class T extends HTMLElement{constructor(){super();m(this,"form",this.querySelector("form")||null);m(this,"storeKey",this.hasAttribute("store")?this.getAttribute("store")||`action-form-${this.id||this.form.id||S()}`:"");m(this,"persistedFields",[]);m(this,"data",M(this.form));m(this,"steps",w(this.querySelectorAll("af-step")));const t=this.form;if(t){this.hasAttribute("novalidate")&&t.setAttribute("novalidate",""),this.persistedFields=Array.from(this.querySelectorAll("[data-persist]")).filter(e=>b(e)),this.storeKey&&this.restoreFieldValues(),window.addEventListener("storage",e=>{this.log("storage",e,e.key),this.hasAttribute("store-listen")&&e.key===this.storeKey&&this.restoreFieldValues()}),v(()=>{this.log("ðŸ«¨ create effect ~ action-form: step activation");const e=this.steps.currentStep();this.steps.all.forEach(a=>{a===e?a.classList.add("active"):a.classList.remove("active")})});const r=Array.from(this.querySelectorAll("af-field-group")),s=Array.from(this.querySelectorAll("[required],[pattern],[type=phone],[type=email],[type=url],[minlength],[maxlength]"));[...r,...s].forEach(e=>{e.id||(e.id=S(`${e.tagName.toLowerCase()}${e.name?`-${e.name}`:""}`))}),this.hasAttribute("auto-error")&&(s.forEach(e=>{var n;if(e.hasAttribute("aria-describedby"))return;const a=t.querySelector(`af-error[for="${e.id}"]`),i=(n=e.closest("label"))==null?void 0:n.querySelector("af-error");!a&&!i&&(e.after(this.createAfError(e)),this.log(`Added Error Message for ${e.id}`))}),r.forEach(e=>{if(e.hasAttribute("aria-describedby"))return;e.querySelector(`af-error[for="${e.id}"]`)||(e.append(this.createAfError(e)),this.log(`Added Error Message for ${e.id}`))})),new Set(Array.from(t.elements).map(e=>e.name||"").filter(e=>e)).forEach(e=>{this.data.set(e)}),t.addEventListener("change",e=>{const a=e.target;a instanceof HTMLElement&&(a.name&&(this.data.set(a.name),this.data.setForm()),this.storeKey&&localStorage.setItem(this.storeKey,JSON.stringify(this.data.formDataObject())))}),[...s,...r].forEach(e=>{v(()=>{this.log("ðŸ«¨ create effect ~ action-form: error checking"),this.data.get(e.name),this.toggleError(e)})}),this.querySelectorAll("[data-if],[data-text]").forEach(e=>{if(e instanceof HTMLElement){const a=e.dataset.if,i=e.dataset.text;v(()=>{if(this.log("ðŸ«¨ create effect: action-form: enhance elements"),a){const n=this.data.get(a);if(n){const h=e.dataset.ifValue,d=e.dataset.ifNotValue,y=e.dataset.ifRegex,g=y?new RegExp(y):void 0;if(h||d||g){const A=n.some(p=>typeof p=="string"&&(h&&p===h||g&&g.test(p)))&&n.every(p=>typeof p=="string"&&(!d||p!==d));this.show(e,A)}else this.show(e,!!n.some(A=>!!A))}}if(i){const n=this.data.get(i);n&&(e.textContent=n==null?void 0:n.toString())}})}}),this.querySelectorAll("button[type=reset]").forEach(e=>{e.addEventListener("click",a=>{a.preventDefault(),this.persistedFields.forEach(i=>b(i)?i.dataset.persist=i.value:null),this.form.reset(),this.persistedFields.forEach(i=>b(i)&&typeof i.dataset.persist=="string"?i.value=i.dataset.persist:null),this.restoreForm()})}),this.addEventListener("submit",e=>{if(t.checkValidity())this.restoreForm();else{e.preventDefault();const i=this.form.querySelector(":invalid:not(fieldset)");if(i&&i instanceof HTMLElement){const n=i.closest("af-step"),h=this.steps.getVisible().findIndex(d=>d===n);if(h!==-1)this.steps.set(h),this.steps.next();else throw new Error(`Invalid field: ${i.id}`)}}})}}createAfError(t){const r=document.createElement("af-error");if(r.setAttribute("for",t.id),r.textContent=t.dataset.error||"",t.dataset.errorPattern){const s=document.createElement("span");s.setAttribute("slot","pattern"),s.textContent=t.dataset.errorPattern,r.append(s)}return r}toggleError(t){const r=document.getElementById(t.getAttribute("aria-describedby")||"");if(r&&typeof t.checkValidity=="function"){const s=t.checkValidity();this.log("errorMsg.id, valid",r.id,s),s?this.resetError(t,r):(r.style.visibility="visible",t.setAttribute("aria-invalid","true"),r.dataset.invalid=t.value===""?"required":"pattern")}}resetError(t,r){t.removeAttribute("aria-invalid"),r.style.visibility="hidden",r.removeAttribute("data-invalid")}restoreForm(){this.resetStore(),this.querySelectorAll("[aria-invalid]").forEach(r=>{if(x(r)){const s=document.getElementById(r.getAttribute("aria-describedby")||"");s&&this.resetError(r,s)}})}resetStore(){const t=localStorage.getItem(this.storeKey);if(t&&this.persistedFields.length>0){const r=JSON.parse(t);Object.keys(r).forEach(s=>{this.persistedFields.every(u=>u.name!==s)&&delete r[s]}),localStorage.setItem(this.storeKey,JSON.stringify(r))}else localStorage.removeItem(this.storeKey)}restoreFieldValues(){const t=localStorage.getItem(this.storeKey);if(!t||t==="undefined")return;const r=JSON.parse(t);typeof r=="object"&&Object.keys(r).forEach(s=>{this.querySelectorAll(`[name="${s}"]`).forEach(l=>{b(l)&&!l.matches("[type=hidden]")&&(l instanceof HTMLInputElement&&["checkbox","radio"].includes(l.type)&&r[s]instanceof Array?l.checked=r[s].includes(l.value):l.value=String(r[s]))})})}show(t,r){r?(t.style.display="",t.removeAttribute("disabled")):(t.style.display="none",t.setAttribute("disabled","")),t.dispatchEvent(new Event("change",{bubbles:!0})),t.matches("af-step")&&this.steps.updateSteps(),t.matches("fieldset")&&t.querySelectorAll("input, select, textarea").forEach(u=>{this.data.set(u.name)})}log(...t){this.hasAttribute("debug")&&console.log(...t)}}customElements.define("action-form",T);customElements.define("af-error",L);export{T as A};
//# sourceMappingURL=action-form.js.map
